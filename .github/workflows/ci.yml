name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # 1. BUILD BINARIES
  build-binaries:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 10.0.x

    - name: Publish (Targeting Linux ARM64)
      run: dotnet publish WhiskeyTracker.Web/WhiskeyTracker.Web.csproj -c Release -r linux-arm64 --self-contained false -o ./publish

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: app-binaries
        path: ./publish
        retention-days: 1

  # 2. RUN TESTS
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_PASSWORD: whiskeypass
          POSTGRES_DB: whiskey_test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v4
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 10.0.x
    
    - name: Test
      run: dotnet test
      env:
        Database__Provider: Postgres
        Database__ConnectionString: "Host=localhost;Database=whiskey_test_db;Username=postgres;Password=whiskeypass"
        Database__SeedOnStartup: true

  # 3. DEPLOY TO PI CLUSTER
  deploy:
    runs-on: self-hosted
    needs: [build-binaries, test]
    if: github.ref == 'refs/heads/main'
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download Artifacts
      uses: actions/download-artifact@v4
      with:
        name: app-binaries
        path: ./publish

    - name: Inject Secrets
      run: |
        echo "${{ secrets.SECRETS_ENV_FILE }}" > k8s/.env
      
    - name: Apply Infrastructure
      run: kubectl apply -k k8s/

    - name: Start Loader Pod
      run: |
        cat <<EOF | kubectl apply -f -
        apiVersion: v1
        kind: Pod
        metadata:
          name: content-loader
        spec:
          containers:
          - name: loader
            image: alpine  # Lightweight, has tar
            command: ["sleep", "infinity"]
            volumeMounts:
            - mountPath: /app
              name: app-storage
          volumes:
          - name: app-storage
            persistentVolumeClaim:
              claimName: whiskey-app-pvc
        EOF
        
        echo "Waiting for loader pod..."
        kubectl wait --for=condition=Ready pod/content-loader --timeout=60s

    - name: Copy Files to NFS
      run: |
        # Clear existing files (optional, but safer to avoid stale DLLs)
        kubectl exec content-loader -- rm -rf /app/*
        
        # Copy new files
        kubectl cp ./publish/. content-loader:/app/
        
        # Verify
        kubectl exec content-loader -- ls -la /app

    - name: Cleanup Loader
      if: always()
      run: kubectl delete pod content-loader --ignore-not-found

    - name: Restart Deployment
      run: kubectl rollout restart deployment/whiskey-web
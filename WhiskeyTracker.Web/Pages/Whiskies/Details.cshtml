@page "{id:int}"
@model WhiskeyTracker.Web.Pages.Whiskies.DetailsModel
@{
    ViewData["Title"] = "Details";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-4">
            @if (!string.IsNullOrEmpty(Model.Whiskey.ImageFileName))
            {
                <img src="~/images/@Model.Whiskey.ImageFileName" class="img-fluid rounded shadow mb-3"
                     alt="@Model.Whiskey.Name" />
            }
            else
            {
                <div class="alert alert-secondary text-center p-5 mb-3">No Image Available</div>
            }

            <div class="d-grid gap-2">
                <a asp-page="./Edit" asp-route-id="@Model.Whiskey.Id" class="btn btn-warning">Edit Definition</a>
                <a asp-page="./Index" class="btn btn-outline-secondary">Back to Library</a>
            </div>
        </div>

        <div class="col-md-8">
            <h1 class="display-5">@Model.Whiskey.Distillery</h1>
            <h2 class="text-muted h4">@Model.Whiskey.Name</h2>
            <hr />

            <dl class="row">
                <dt class="col-sm-4">Region</dt>
                <dd class="col-sm-8">@Model.Whiskey.Region</dd>

                <dt class="col-sm-4">Age</dt>
                <dd class="col-sm-8">
                    @(Model.Whiskey.Age.HasValue ? $"{Model.Whiskey.Age} Years" : "No Age Statement")
                </dd>

                <dt class="col-sm-4">ABV</dt>
                <dd class="col-sm-8">
                    @(Model.Whiskey.ABV.HasValue ? $"{Model.Whiskey.ABV}%" : "-")
                </dd>

                <dt class="col-sm-4">Cask Type</dt>
                <dd class="col-sm-8">@Model.Whiskey.CaskType</dd>
            </dl>

            <div class="d-flex justify-content-between align-items-center mt-5 mb-3 bg-light p-2 rounded">
                <h3 class="h5 m-0">Inventory History</h3>
                <a asp-page="./AddBottle" asp-route-id="@Model.Whiskey.Id" class="btn btn-sm btn-success">
                    + Add Bottle
                </a>
            </div>

            @if (Model.Whiskey.Bottles.Count == 0)
            {
                <p class="text-muted fst-italic">You haven't logged any bottles of this yet.</p>
            }
            else
            {
                <table class="table table-sm table-hover align-middle">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th style="width: 20%;">Volume</th>
                            <th>Type</th>
                            <th>Purchased</th>
                            <th>Price</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var bottle in Model.Whiskey.Bottles)
                        {
                            <tr>
                                <td>
                                    @if (bottle.Status == WhiskeyTracker.Web.Data.BottleStatus.Empty)
                                    {
                                        <span class="badge bg-secondary">Empty</span>
                                    }
                                    else if (bottle.Status == WhiskeyTracker.Web.Data.BottleStatus.Opened)
                                    {
                                        <span class="badge bg-warning text-dark">Opened</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success">Full</span>
                                    }
                                </td>
                                
                                <td>
                                    @if (bottle.CapacityMl > 0)
                                    {
                                        var percent = (double)bottle.CurrentVolumeMl / bottle.CapacityMl * 100;
                                        <div class="d-flex flex-column" style="font-size: 0.8rem;">
                                            <span>@bottle.CurrentVolumeMl / @bottle.CapacityMl ml</span>
                                            <div class="progress" style="height: 4px; width: 100%;">
                                                <div class="progress-bar bg-info" role="progressbar" style="width: @percent%"></div>
                                            </div>
                                        </div>
                                    }
                                    else
                                    {
                                        <span>@bottle.CurrentVolumeMl ml</span>
                                    }
                                </td>

                                <td class="text-center">
                                    @(bottle.IsInfinityBottle ? "‚ôæÔ∏è" : "-")
                                </td>

                                <td>@(bottle.PurchaseDate.HasValue ? bottle.PurchaseDate.Value.ToShortDateString() : "-")</td>
                                <td>@(bottle.PurchasePrice.HasValue ? bottle.PurchasePrice.Value.ToString("C") : "-")</td>
                                
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a asp-page="./EditBottle" asp-route-id="@bottle.Id" class="btn btn-outline-primary" title="Edit Bottle">Edit</a>
                                        
                                        @if (bottle.Status == WhiskeyTracker.Web.Data.BottleStatus.Opened && !bottle.IsInfinityBottle)
                                        {
                                            @if (bottle.CurrentVolumeMl <= 150)
                                            {
                                                <a asp-page="./Pour" asp-route-id="@bottle.Id" class="btn btn-success" title="Finish into Infinity Bottle">
                                                    ‚ôæÔ∏è Finish
                                                </a>
                                            }
                                            else
                                            {
                                                <a asp-page="./Pour" asp-route-id="@bottle.Id" class="btn btn-outline-secondary" title="Pour into Infinity">
                                                    ‚ôæÔ∏è Pour
                                                </a>
                                            }
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }

            <div class="mt-5">
                <div class="d-flex justify-content-between align-items-center mb-3 bg-light p-2 rounded">
                    <h3 class="h5 m-0">Tasting Journal</h3>
                    <span class="badge bg-primary">
                        @if (Model.Whiskey.TastingNotes.Any())
                        {
                            <span>Avg: @Model.Whiskey.TastingNotes.Average(n => n.Rating).ToString("0.0") ‚òÖ</span>
                        }
                        else
                        {
                            <span>No Ratings Yet</span>
                        }
                    </span>
                </div>

                @if (Model.Whiskey.TastingNotes.Count == 0)
                {
                    <p class="text-muted fst-italic">You haven't tasted this whiskey in a session yet.</p>
                }
                else
                {
                    <div class="list-group list-group-flush">
                        @foreach (var note in Model.Whiskey.TastingNotes.OrderByDescending(n => n.TastingSession.Date))
                        {
                            <div class="list-group-item px-0">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1 fw-bold">@note.TastingSession.Title</h6>
                                    <small class="text-muted">@note.TastingSession.Date.ToShortDateString()</small>
                                </div>
                                
                                @if (note.Bottle != null)
                                {
                                    <div class="mb-2">
                                        <small class="badge bg-light text-dark border">
                                            <i class="bi bi-box-seam"></i> From Bottle purchased
                                            @(note.Bottle.PurchaseDate?.ToShortDateString() ?? "Unknown")
                                        </small>
                                        @if(note.PourAmountMl > 0)
                                        {
                                            <small class="badge bg-light text-dark border ms-1">
                                                ü•É @note.PourAmountMl ml
                                            </small>
                                        }
                                    </div>
                                }

                                <div class="mb-2">
                                    <span class="text-warning">
                                        @for (int i = 0; i < note.Rating; i++)
                                        {
                                            <span>‚òÖ</span>
                                        }
                                    </span>
                                </div>
                                <p class="mb-1 text-muted">@note.Notes</p>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </div>
</div>